rules_version = '2';

service firebase.storage {
  match /b/seminar-cloud-uploads/o {

    // --- Helpers ---
    function isAllowedContentType() {
      return request.resource.contentType.matches('video/.*') ||
             request.resource.contentType.matches('image/.*') ||
             request.resource.contentType.matches('application/pdf');
    }

    function isAdmin() {
      let userDoc = firestore.get(
        /databases/(default)/documents/artifacts/seminar-cloud/users/$(request.auth.uid)
      );
      return userDoc.data != null && userDoc.data.role == 'admin';
    }

    // --- Per-user uploads ---
    match /artifacts/{appId}/users/{userId}/{allPaths=**} {
      allow create, update: if request.auth != null
                            && request.auth.uid == userId
                            && isAllowedContentType();

      allow get, delete: if request.auth != null
                         && request.auth.uid == userId;

      // Admin override
      allow get: if isAdmin();
    }
  }
}
