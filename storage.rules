rules_version = '2';

service firebase.storage {
  // MUST MATCH your real bucket
  match /b/seminar-cloud-uploads.appspot.com/o {

    /* ------------------------------ */
    /*      Allowed File Types        */
    /* ------------------------------ */
    function isAllowedContentType() {
      return request.resource.contentType.matches('video/.*') ||
             request.resource.contentType.matches('image/.*') ||
             request.resource.contentType.matches('application/pdf');
    }

    /* ------------------------------ */
    /*      Admin Role Checker        */
    /* ------------------------------ */
    function isAdmin(appId) {
      let userDoc = firestore.get(
        /databases/(default)/documents/artifacts/$(appId)/users/$(request.auth.uid)
      );
      return userDoc.data != null && userDoc.data.role == 'admin';
    }

    /* ------------------------------ */
    /*     Main Artifact Structure    */
    /* ------------------------------ */
    match /artifacts/{appId}/users/{userId}/{allPaths=**} {

      // Users may upload/update their own files only
      allow create, update: if request.auth != null
                            && request.auth.uid == userId
                            && isAllowedContentType();

      // Users may read or delete ONLY their own files
      allow get, delete: if request.auth != null
                         && request.auth.uid == userId;

      // Admins may read everything
      allow get: if isAdmin(appId);
    }
  }
}
